<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TailorFlow Pro | Precision Measurement System</title>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --bg-main: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            line-height: 1.5;
            min-height: 100vh;
        }

        /* Layout */
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            background: var(--bg-card);
            padding: 16px 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .logo {
            font-weight: 800;
            font-size: 1.5rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            background: #f1f5f9;
            padding: 4px;
            border-radius: 10px;
        }

        .tab-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-muted);
            transition: 0.2s;
        }

        .tab-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Views */
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.3s ease; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard Cards */
        .garment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .garment-card {
            background: var(--bg-card);
            padding: 30px;
            border-radius: var(--radius);
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: 0.3s;
            box-shadow: var(--shadow);
        }

        .garment-card:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
        }

        .garment-card i {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 12px;
        }

        .garment-card h3 { font-size: 1.2rem; }

        /* Measurement Flow Interface */
        .measurement-ui {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            gap: 24px;
            align-items: start;
        }

        /* Panels */
        .steps-panel, .visualizer-panel {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            position: sticky;
            top: 20px;
        }

        .visualizer-panel {
            text-align: center;
        }

        .progress-container {
            margin-bottom: 20px;
        }

        .progress-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }

        .step-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 4px;
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            transition: 0.2s;
        }

        .step-item.active {
            background: #eff6ff;
            color: var(--primary);
            font-weight: 700;
        }

        .step-item.completed { color: var(--success); }

        .step-num {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 0.75rem;
        }

        .step-item.active .step-num { background: var(--primary); color: white; }
        .step-item.completed .step-num { background: var(--success); color: white; }

        /* Right Panel: Form */
        .form-panel {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: var(--shadow);
        }

        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 16px;
        }

        .customer-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        input, select {
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
            transition: 0.2s;
        }

        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

        /* Measurement Input Specifics */
        .measurement-field {
            padding: 24px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 16px;
            background: #fff;
            transition: 0.3s;
        }

        .measurement-field.active {
            border-color: var(--primary);
            background: #fdfefe;
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.05);
        }

        .measurement-field.hidden { display: none; }

        .field-row {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .main-input-wrap {
            position: relative;
            flex-grow: 1;
        }

        .big-input {
            width: 100%;
            font-size: 2.5rem;
            font-weight: 800;
            padding: 10px 20px;
            text-align: center;
            border-radius: 12px;
        }

        .unit-indicator {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: 700;
            color: var(--text-muted);
        }

        .common-sizes {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .size-chip {
            padding: 6px 14px;
            background: #f1f5f9;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            border: none;
            font-weight: 600;
        }

        .size-chip:hover { background: #e2e8f0; }

        /* Voice Controls */
        .voice-bar {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            z-index: 100;
            width: max-content;
            max-width: 90vw;
        }

        .voice-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: var(--primary);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
        }

        .voice-btn.listening {
            background: var(--error);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .transcript {
            font-size: 0.9rem;
            font-style: italic;
            color: #94a3b8;
            max-width: 300px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Action Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
        .btn-ghost:hover { background: #f8fafc; }

        /* Utility */
        .badge-warning {
            background: #fffbeb;
            color: #b45309;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #fde68a;
            font-size: 0.85rem;
            margin-top: 10px;
            display: none;
        }

        /* Orders List */
        .orders-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .orders-table th, .orders-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .orders-table th { background: #f8fafc; font-weight: 600; }

        /* Visualizer SVG Styles */
        #body-visualizer-svg line, #body-visualizer-svg ellipse, #body-visualizer-svg circle {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            stroke-width: 2;
            fill: none;
            stroke: #cbd5e1;
        }

        #body-visualizer-svg .v-active {
            stroke: var(--primary);
            stroke-width: 4;
            filter: drop-shadow(0 0 4px var(--primary));
        }

        #body-visualizer-svg .v-completed {
            stroke: var(--success);
            stroke-width: 3;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            border-radius: var(--radius);
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        }

        /* LUXURY PRINT STYLES */
        @media print {
            .no-print { display: none !important; }
            body { background: white; color: black; padding: 0; margin: 0; }
            .app-container { max-width: 100%; padding: 0; margin: 0; }
            .print-receipt { display: block !important; }
            
            @page {
                size: A4;
                margin: 2cm;
            }
        }

        .print-receipt {
            display: none;
            background: white;
            color: #1a1a1a;
            padding: 20px;
        }

        .receipt-header {
            text-align: center;
            border-bottom: 2px solid #000;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .receipt-header h1 {
            font-size: 2.5rem;
            font-weight: 900;
            letter-spacing: 2px;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .receipt-header p {
            font-size: 0.9rem;
            color: #444;
            letter-spacing: 1px;
        }

        .receipt-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            font-size: 0.95rem;
        }

        .receipt-section-title {
            background: #f4f4f4;
            padding: 8px 15px;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 1px;
            margin-bottom: 15px;
            border-left: 4px solid #000;
        }

        .receipt-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px 40px;
            margin-bottom: 40px;
        }

        .receipt-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .receipt-item .label { font-weight: 600; color: #555; }
        .receipt-item .value { font-weight: 800; color: #000; font-size: 1.1rem; }

        .receipt-footer {
            margin-top: 60px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .signature-box {
            width: 200px;
            border-top: 1px solid #000;
            text-align: center;
            padding-top: 10px;
            font-size: 0.8rem;
            text-transform: uppercase;
            font-weight: 700;
        }

        .thank-you {
            text-align: center;
            font-style: italic;
            font-size: 0.9rem;
            margin-top: 40px;
            color: #666;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .measurement-ui { grid-template-columns: 240px 1fr; }
            .visualizer-panel { display: none; }
        }

        @media (max-width: 768px) {
            .measurement-ui { grid-template-columns: 1fr; }
            .steps-panel { position: relative; top: 0; order: 2; }
            .form-panel { order: 1; }
            .voice-bar { width: 95vw; border-radius: 12px; bottom: 10px; }
            .field-row { flex-direction: column; align-items: stretch; }
            .big-input { font-size: 1.8rem; }
        }

        /* ✅ Mobile Bottom Step Navigation */
.mobile-nav {
  display: none;
}

@media (max-width: 768px) {
  .mobile-nav {
    display: flex;
    position: fixed;
    left: 12px;
    right: 12px;
    bottom: 12px;
    z-index: 999;
    background: rgba(15, 23, 42, 0.92);
    color: white;
    border-radius: 16px;
    padding: 10px 12px;
    gap: 10px;
    align-items: center;
    box-shadow: 0 10px 25px rgba(0,0,0,0.35);
    backdrop-filter: blur(10px);
  }

  .mobile-nav .m-btn {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    border: 1px solid rgba(226, 232, 240, 0.15);
    background: rgba(37, 99, 235, 0.95);
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: 0.2s;
    flex-shrink: 0;
  }

  .mobile-nav .m-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    background: rgba(100, 116, 139, 0.5);
  }

  .mobile-nav .m-mid {
    flex: 1;
    min-width: 0;
  }

  .mobile-nav .m-title {
    font-weight: 800;
    font-size: 0.85rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .mobile-nav .m-sub {
    display: flex;
    justify-content: space-between;
    font-size: 0.7rem;
    color: rgba(226, 232, 240, 0.75);
    margin-top: 2px;
  }

  .mobile-nav .m-progress {
    height: 6px;
    background: rgba(226, 232, 240, 0.18);
    border-radius: 999px;
    overflow: hidden;
    margin-top: 8px;
  }

  .mobile-nav .m-progress > div {
    height: 100%;
    width: 0%;
    background: #22c55e;
    transition: width 0.25s ease;
  }

  /* Give space so bottom nav doesn't overlap last field */
  #measurement-phase {
    padding-bottom: 90px;
  }

  /* Your voice bar already exists. Keep it above nav on mobile */
  .voice-bar {
    bottom: 88px !important;
  }
}

    </style>
</head>
<body>


    <!-- ✅ Mobile Step Navigation -->
<div class="mobile-nav no-print" id="mobile-nav" style="display:none;">
  <button class="m-btn" id="m-prev" onclick="mobilePrev()">
    <i data-lucide="chevron-left"></i>
  </button>

  <div class="m-mid">
    <div class="m-title" id="m-step-title">Step</div>
    <div class="m-sub">
      <span id="m-step-count">1/1</span>
      <span id="m-step-pct">0% Complete</span>
    </div>
    <div class="m-progress"><div id="m-progress-fill"></div></div>
  </div>

  <button class="m-btn" id="m-next" onclick="mobileNext()">
    <i data-lucide="chevron-right"></i>
  </button>
</div>


    <div class="app-container">
        <!-- Header -->
        <header class="no-print">
            <div class="logo">
                <i data-lucide="scissors"></i>
                TailorFlow Pro
            </div>
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('new-order')">New Order</button>
                <button class="tab-btn" onclick="switchTab('orders-list')">Saved Orders</button>
            </div>
            <div id="global-controls" style="display: flex; gap: 10px; align-items: center;">
                <div class="input-group" style="flex-direction: row; align-items: center; gap: 5px;">
                    <label style="white-space: nowrap;">Prefix:</label>
                    <input type="text" id="order-prefix" value="TF" style="padding: 5px 10px; width: 60px;">
                </div>
                <select id="unit-toggle" onchange="toggleGlobalUnits()">
                    <option value="inch">Inches (in)</option>
                    <option value="cm">Centimeters (cm)</option>
                </select>
            </div>
        </header>

        <!-- NEW ORDER VIEW -->
        <div id="new-order" class="view active">
            
            <!-- Step 1: Selection -->
            <div id="selection-phase">
                <h2 style="margin-bottom: 20px;">Select Garment Type</h2>
                <div class="garment-grid">
                    <div class="garment-card" onclick="initOrder('shirt')">
                        <i data-lucide="shirt"></i>
                        <h3>Shirt</h3>
                    </div>
                    <div class="garment-card" onclick="initOrder('pant')">
                        <i data-lucide="pi-square"></i>
                        <h3>Trousers / Pant</h3>
                    </div>
                    <div class="garment-card" style="opacity: 0.5; cursor: not-allowed;">
                        <i data-lucide="briefcase"></i>
                        <h3>Blazer (Soon)</h3>
                    </div>
                </div>
            </div>

            <!-- Step 2: Form -->
            <div id="measurement-phase" style="display: none;">
                <div class="measurement-ui">
                    
                    <!-- Left: Navigation -->
                    <aside class="steps-panel no-print">
                        <div class="progress-container">
                            <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 5px;">
                                <span id="progress-text">0% Complete</span>
                                <span id="step-count">0/0</span>
                            </div>
                            <div class="progress-bar">
                                <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        <div id="steps-list">
                            <!-- Dynamic steps here -->
                        </div>
                        
                        <div style="margin-top: 24px; display: flex; flex-direction: column; gap: 8px;">
                            <button class="btn btn-ghost" onclick="resetOrder()">
                                <i data-lucide="rotate-ccw" size="18"></i> Cancel Order
                            </button>
                        </div>
                    </aside>

                    <!-- Center: Form Area -->
                    <main class="form-panel">
                        <div class="form-header no-print">
                            <h2 id="active-garment-title">Shirt Measurements</h2>
                            <div class="no-print">
                                <button class="btn btn-ghost" onclick="toggleShowAll()" id="show-all-btn">
                                    <i data-lucide="eye"></i> Show All
                                </button>
                            </div>
                        </div>

                        <!-- Customer Details -->
                        <div class="customer-info-grid no-print">
                            <div class="input-group">
                                <label>Customer Name</label>
                                <input type="text" id="cust-name" placeholder="John Doe">
                            </div>
                            <div class="input-group">
                                <label>Phone Number</label>
                                <input type="tel" id="cust-phone" placeholder="9876543210">
                            </div>
                            <div class="input-group">
                                <label>Order ID</label>
                                <input type="text" id="order-id" readonly>
                            </div>
                        </div>

                        <!-- Measurement Fields -->
                        <div id="fields-container" class="no-print">
                            <!-- Dynamic fields here -->
                        </div>

                        <!-- Footer Actions -->
                        <div style="margin-top: 40px; display: flex; gap: 12px; border-top: 1px solid var(--border); padding-top: 24px;" class="no-print">
                            <button class="btn btn-primary" onclick="saveCurrentOrder()">
                                <i data-lucide="save"></i> Save Order
                            </button>
                            <button class="btn btn-ghost" onclick="readBackAll()">
                                <i data-lucide="volume-2"></i> Read Back
                            </button>
                            <button class="btn btn-ghost" onclick="printLuxuryReceipt()">
                                <i data-lucide="printer"></i> Print Receipt
                            </button>
                        </div>
                    </main>

                    <!-- Right: Visualizer -->
                    <aside class="visualizer-panel no-print">
                        <h3 style="margin-bottom: 20px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted);">Body Visualizer</h3>
                        <svg id="body-visualizer-svg" viewBox="0 0 200 400" width="100%" height="auto">
                            <!-- Static Human Outline -->
                            <path d="M100,40 C110,40 120,45 120,60 C120,75 110,80 100,80 C90,80 80,75 80,60 C80,45 90,40 100,40 M80,80 Q50,85 45,110 L40,180 Q38,200 50,200 L60,200 L65,130 Q70,120 100,120 Q130,120 135,130 L140,200 L150,200 Q162,200 160,180 L155,110 Q150,85 120,80 M65,130 L65,300 Q65,310 80,310 L95,310 L95,380 L105,380 L105,310 L120,310 Q135,310 135,300 L135,130" stroke="#e2e8f0" fill="none" stroke-width="1.5" />
                            
                            <!-- Measurement Overlays -->
                            <!-- Neck -->
                            <circle id="v-neck" cx="100" cy="78" r="8" />
                            <!-- Shoulder -->
                            <line id="v-shoulder" x1="80" y1="85" x2="120" y2="85" />
                            <!-- Chest -->
                            <ellipse id="v-chest" cx="100" cy="115" rx="30" ry="12" />
                            <!-- Waist -->
                            <ellipse id="v-waist" cx="100" cy="160" rx="25" ry="10" />
                            <!-- Hip -->
                            <ellipse id="v-hip" cx="100" cy="200" rx="32" ry="12" />
                            <!-- Sleeve Length (Left/Right) -->
                            <line id="v-sleeve_len-L" x1="60" y1="88" x2="45" y2="150" />
                            <line id="v-sleeve_len-R" x1="140" y1="88" x2="155" y2="150" />
                            <!-- Shirt Length -->
                            <line id="v-length" x1="100" y1="80" x2="100" y2="240" />
                            
                            <!-- Pant Visualizer Overlays -->
                            <line id="v-outseam" x1="135" y1="180" x2="135" y2="380" stroke-dasharray="4" style="display:none;" />
                            <line id="v-inseam" x1="105" y1="220" x2="105" y2="380" stroke-dasharray="4" style="display:none;" />
                        </svg>
                        <div id="v-feedback" style="margin-top: 15px; font-size: 0.8rem; font-weight: 700; color: var(--primary);">READY</div>
                    </aside>

                </div>
            </div>
        </div>

        <!-- ORDERS LIST VIEW -->
        <div id="orders-list" class="view">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2>All Orders</h2>
                <input type="text" id="order-search" placeholder="Search by name or phone..." oninput="renderOrders()">
            </div>
            <div id="orders-container">
                <!-- Dynamic table -->
            </div>
        </div>

        <!-- Voice Command Bar -->
        <div class="voice-bar no-print" id="voice-bar" style="display: none;">
            <button class="voice-btn" id="voice-toggle-btn" onclick="toggleVoice()">
                <i data-lucide="mic" id="mic-icon"></i>
            </button>
            <div style="flex-grow: 1;">
                <div style="font-weight: 700; font-size: 0.8rem; margin-bottom: 2px;">
                    VOICE MODE: <span id="voice-mode-display" style="color: var(--primary);">SEQUENCE</span>
                    <button onclick="toggleVoiceMode()" style="background: none; border: none; color: #94a3b8; text-decoration: underline; font-size: 0.7rem; cursor: pointer; margin-left: 10px;">Switch Mode</button>
                </div>
                <div class="transcript" id="voice-transcript">Press mic to start speaking measurements...</div>
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="btn btn-ghost" style="padding: 6px 12px; font-size: 0.7rem; border-color: #475569; color: white;" onclick="undoLastVoice()">Undo</button>
            </div>
        </div>

    </div>

    <!-- Luxury Print Template (Hidden in UI) -->
    <div class="print-receipt" id="luxury-receipt">
        <div class="receipt-header">
            <h1>TailorFlow Luxury</h1>
            <p>Bespoke Excellence & Professional Tailoring</p>
            <p style="font-size: 0.75rem; margin-top: 5px;">123 High Street, Fashion District • +1 234 567 890</p>
        </div>

        <div class="receipt-meta">
            <div>
                <p><strong>ORDER ID:</strong> <span id="print-order-id"></span></p>
                <p><strong>DATE:</strong> <span id="print-date"></span></p>
            </div>
            <div style="text-align: right;">
                <p><strong>GARMENT:</strong> <span id="print-garment-type" style="text-transform: uppercase;"></span></p>
                <p><strong>UNIT:</strong> <span id="print-unit"></span></p>
            </div>
        </div>

        <div class="receipt-section-title">Client Information</div>
        <div style="margin-bottom: 30px; font-size: 1.1rem;">
            <p><strong>NAME:</strong> <span id="print-cust-name"></span></p>
            <p><strong>PHONE:</strong> <span id="print-cust-phone"></span></p>
        </div>

        <div class="receipt-section-title">Measurement Specifications</div>
        <div class="receipt-grid" id="print-measurements-grid">
            <!-- Populated dynamically -->
        </div>

        <div class="receipt-footer">
            <div class="signature-box">Client Signature</div>
            <div class="signature-box">Master Tailor</div>
        </div>

        <div class="thank-you">
            Thank you for choosing TailorFlow. We strive for a perfect fit every time.
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal">
            <h3 id="modal-title">Alert</h3>
            <p id="modal-message" style="margin: 15px 0; color: var(--text-muted);"></p>
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" id="modal-confirm-btn">Confirm</button>
            </div>
        </div>
    </div>

    <script>


/**
         * TAILORFLOW PRO - LOGIC ENGINE
         */

        // 1. Data Definitions
        const GARMENT_CONFIG = {
            shirt: [
                { key: 'shoulder', label: 'Shoulder', req: true, min: 12, max: 24, common: [16, 17, 18, 19], synonyms: ['shoulder', 'sholder', 'shoulders'] },
                { key: 'chest', label: 'Chest', req: true, min: 28, max: 65, common: [36, 38, 40, 42, 44], synonyms: ['chest', 'body', 'bust'] },
                { key: 'waist', label: 'Waist', req: true, min: 24, max: 65, common: [32, 34, 36, 38, 40], synonyms: ['waist', 'middle', 'stomach'] },
                { key: 'hip', label: 'Hip', req: false, min: 28, max: 75, common: [38, 40, 42, 44], synonyms: ['hip', 'seat', 'bottom'] },
                { key: 'sleeve_len', label: 'Sleeve Length', req: true, min: 18, max: 35, common: [23, 24, 25, 26], synonyms: ['sleeve', 'hand', 'arm'] },
                { key: 'armhole', label: 'Armhole', req: false, min: 14, max: 28, common: [18, 19, 20], synonyms: ['armhole', 'opening'] },
                { key: 'cuff', label: 'Cuff', req: false, min: 6, max: 15, common: [9, 9.5, 10], synonyms: ['cuff', 'wristband'] },
                { key: 'length', label: 'Shirt Length', req: true, min: 20, max: 45, common: [28, 29, 30, 31], synonyms: ['length', 'long', 'height'] },
                { key: 'neck', label: 'Neck', req: true, min: 12, max: 25, common: [15, 16, 17], synonyms: ['neck', 'collar'] },
                { key: 'wrist', label: 'Wrist (Optional)', req: false, min: 5, max: 12, common: [7, 8], synonyms: ['wrist'] }
            ],
            pant: [
                { key: 'waist', label: 'Waist', req: true, min: 24, max: 65, common: [30, 32, 34, 36], synonyms: ['waist', 'belt'] },
                { key: 'hip', label: 'Hip', req: true, min: 30, max: 75, common: [36, 38, 40, 42], synonyms: ['hip', 'seat'] },
                { key: 'thigh', label: 'Thigh', req: true, min: 18, max: 40, common: [22, 24, 26], synonyms: ['thigh'] },
                { key: 'knee', label: 'Knee', req: false, min: 14, max: 28, common: [18, 19, 20], synonyms: ['knee'] },
                { key: 'calf', label: 'Calf', req: false, min: 10, max: 22, common: [14, 15, 16], synonyms: ['calf'] },
                { key: 'inseam', label: 'Inseam', req: true, min: 20, max: 45, common: [28, 30, 32], synonyms: ['inseam', 'inside'] },
                { key: 'outseam', label: 'Outseam', req: true, min: 28, max: 55, common: [38, 40, 42], synonyms: ['outseam', 'full length', 'outside'] },
                { key: 'bottom', label: 'Bottom Hem', req: true, min: 10, max: 25, common: [14, 15, 16], synonyms: ['bottom', 'hem', 'leg opening'] },
                { key: 'rise', label: 'Rise', req: false, min: 8, max: 18, common: [10, 11, 12], synonyms: ['rise'] }
            ]
        };

        // 2. App State
        let state = {
            currentGarment: null,
            currentStepIndex: 0,
            values: {}, // Format: { shoulder: 18.5, ... }
            unit: 'inch', // 'inch' or 'cm'
            isListening: false,
            voiceMode: 'SEQUENCE', // 'SEQUENCE' or 'LABEL'
            showAll: false,
            recognition: null,
            history: [], // For undo
            audioCtx: null // For Audio feedback
        };

        // 3. Initialization
        window.onload = () => {
            lucide.createIcons();
            initSpeech();
            renderOrders();
            window.addEventListener('resize', refreshMobileNav);
            refreshMobileNav();

        };

        function switchTab(tabId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`button[onclick="switchTab('${tabId}')"]`).classList.add('active');
        }

        /**
         * AUDIO FEEDBACK LOGIC
         */
        function playSuccessCue() {
            try {
                if (!state.audioCtx) {
                    state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (state.audioCtx.state === 'suspended') {
                    state.audioCtx.resume();
                }

                const oscillator = state.audioCtx.createOscillator();
                const gainNode = state.audioCtx.createGain();

                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, state.audioCtx.currentTime); // High A note
                
                gainNode.gain.setValueAtTime(0, state.audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, state.audioCtx.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, state.audioCtx.currentTime + 0.1);

                oscillator.connect(gainNode);
                gainNode.connect(state.audioCtx.destination);

                oscillator.start();
                oscillator.stop(state.audioCtx.currentTime + 0.1);
            } catch (e) {
                console.warn("Audio feedback failed:", e);
            }
        }

        /**
         * AUTO-INCREMENT ORDER ID LOGIC
         */
        function getNextOrderId() {
            const prefix = document.getElementById('order-prefix').value || 'TF';
            const orders = JSON.parse(localStorage.getItem('tf_orders') || '[]');
            
            // Filter orders that match the current prefix
            const matchingOrders = orders.filter(o => o.id.startsWith(prefix + '-'));
            
            if (matchingOrders.length === 0) {
                return `${prefix}-1001`;
            }

            // Extract numbers and find max
            const numbers = matchingOrders.map(o => {
                const parts = o.id.split('-');
                const num = parseInt(parts[parts.length - 1]);
                return isNaN(num) ? 0 : num;
            });

            const maxNum = Math.max(...numbers);
            return `${prefix}-${maxNum + 1}`;
        }

        function initOrder(type) {
            state.currentGarment = type;
            state.currentStepIndex = 0;
            state.values = {};
            state.history = [];
            state.showAll = false;
            
            document.getElementById('selection-phase').style.display = 'none';
            document.getElementById('measurement-phase').style.display = 'grid';
            document.getElementById('voice-bar').style.display = 'flex';
            document.getElementById('active-garment-title').innerText = `${type.toUpperCase()} Measurements`;
            
            // Set Auto-Incrementing Order ID
            document.getElementById('order-id').value = getNextOrderId();
            
            // Reset customer inputs
            document.getElementById('cust-name').value = '';
            document.getElementById('cust-phone').value = '';
            
            resetVisualizer();
            renderFlow();
            refreshMobileNav();

        }

        function resetOrder() {
            if (Object.keys(state.values).length > 0) {
                if (!confirm("Are you sure? All current measurement data will be lost.")) return;
            // ✅ Mobile nav
            refreshMobileNav();

            }
            state.currentGarment = null;
            document.getElementById('selection-phase').style.display = 'block';
            document.getElementById('measurement-phase').style.display = 'none';
            document.getElementById('voice-bar').style.display = 'none';
            if (state.isListening) toggleVoice();
            refreshMobileNav();
        }

        // 4. Rendering Engine
        function renderFlow() {
            const container = document.getElementById('fields-container');
            const stepsList = document.getElementById('steps-list');
            const config = GARMENT_CONFIG[state.currentGarment];
            
            container.innerHTML = '';
            stepsList.innerHTML = '';

            config.forEach((step, index) => {
                // Step Navigation Item
                const stepItem = document.createElement('div');
                stepItem.className = `step-item ${index === state.currentStepIndex ? 'active' : ''} ${state.values[step.key] ? 'completed' : ''}`;
                stepItem.onclick = () => goToStep(index);
                stepItem.innerHTML = `
                    <div class="step-num">${state.values[step.key] ? '✓' : index + 1}</div>
                    <span>${step.label}</span>
                `;
                stepsList.appendChild(stepItem);

                // Field UI
                const isVisible = state.showAll || (index >= state.currentStepIndex && index < state.currentStepIndex + 3);
                const fieldDiv = document.createElement('div');
                fieldDiv.className = `measurement-field ${index === state.currentStepIndex ? 'active' : ''} ${!isVisible ? 'hidden' : ''}`;
                fieldDiv.id = `field-${step.key}`;
                
                fieldDiv.innerHTML = `
                    <div class="field-row">
                        <div style="width: 150px;">
                            <label style="color: ${step.req ? 'var(--primary)' : 'var(--text-muted)'}">
                                ${step.label} ${step.req ? '*' : ''}
                            </label>
                            <div style="font-size: 0.7rem; color: #94a3b8;">${step.min}-${step.max} ${state.unit}</div>
                        </div>
                        <div class="main-input-wrap">
                            <input type="number" step="0.1" 
                                class="big-input" 
                                placeholder="0.0" 
                                value="${state.values[step.key] || ''}"
                                onchange="updateValue('${step.key}', this.value)"
                                onfocus="state.currentStepIndex = ${index}; updateUIStates();"
                            >
                            <span class="unit-indicator">${state.unit}</span>
                        </div>
                    </div>
                    <div class="common-sizes">
                        ${step.common.map(size => `
                            <button class="size-chip" onclick="updateValue('${step.key}', ${size})">${size}</button>
                        `).join('')}
                    </div>
                    <div class="badge-warning" id="warning-${step.key}">
                        ⚠️ Value seems unusual for ${step.label}. Please confirm.
                    </div>
                `;
                container.appendChild(fieldDiv);
            });

            updateUIStates();
            lucide.createIcons();
        }

        function updateUIStates() {
            const config = GARMENT_CONFIG[state.currentGarment];
            const progress = Math.round((Object.keys(state.values).length / config.length) * 100);
            
            document.getElementById('progress-fill').style.width = `${progress}%`;
            document.getElementById('progress-text').innerText = `${progress}% Complete`;
            document.getElementById('step-count').innerText = `${state.currentStepIndex + 1}/${config.length}`;

            // Sync classes for side steps
            document.querySelectorAll('.step-item').forEach((el, idx) => {
                el.classList.toggle('active', idx === state.currentStepIndex);
                const key = config[idx].key;
                el.classList.toggle('completed', !!state.values[key]);
                el.querySelector('.step-num').innerText = state.values[key] ? '✓' : idx + 1;
            // ✅ Mobile nav sync
            refreshMobileNav();

            });

            // Sync field visibility and active highlight
            document.querySelectorAll('.measurement-field').forEach((el, idx) => {
                const isVisible = state.showAll || (idx >= state.currentStepIndex && idx < state.currentStepIndex + 3);
                el.classList.toggle('hidden', !isVisible);
                el.classList.toggle('active', idx === state.currentStepIndex);
            });

            // Sync Visualizer Highlight
            syncVisualizerStates();
        }

        function goToStep(idx) {
            state.currentStepIndex = idx;
            updateUIStates();
            const field = document.querySelectorAll('.big-input')[idx];
            if (field) field.focus();
        }

        function toggleShowAll() {
            state.showAll = !state.showAll;
            const btn = document.getElementById('show-all-btn');
            btn.innerHTML = state.showAll ? '<i data-lucide="eye-off"></i> Show Less' : '<i data-lucide="eye"></i> Show All';
            renderFlow();
        }

        // 5. Value Management & Logic
        function updateValue(key, val) {
            if (val === '') {
                delete state.values[key];
                updateUIStates();
                updateVisualizer(key, 0);
                return;
            }

            const num = parseFloat(val);
            const config = GARMENT_CONFIG[state.currentGarment].find(c => c.key === key);
            
            // Validation
            const warningEl = document.getElementById(`warning-${key}`);
            if (num < config.min || num > config.max) {
                warningEl.style.display = 'block';
            } else {
                warningEl.style.display = 'none';
            }

            state.values[key] = num;
            
            // Update Visualizer
            updateVisualizer(key, num);

            // Move to next step if sequential and currently on this field
            const idx = GARMENT_CONFIG[state.currentGarment].findIndex(c => c.key === key);
            if (idx === state.currentStepIndex && state.currentStepIndex < GARMENT_CONFIG[state.currentGarment].length - 1) {
                state.currentStepIndex++;
            }
            
            updateUIStates();
            
            // Update the actual input visually in case of voice input
            const input = document.querySelector(`#field-${key} .big-input`);
            if (input) input.value = num;
        }

        /**
         * BODY VISUALIZER LOGIC
         */
        function updateVisualizer(key, value) {
            const el = document.getElementById(`v-${key}`);
            const elL = document.getElementById(`v-${key}-L`);
            const elR = document.getElementById(`v-${key}-R`);
            
            if (!value) return;

            // Map values to reasonable SVG scaling
            let baseVal = value;
            if (state.unit === 'cm') baseVal = value / 2.54;

            switch (key) {
                case 'shoulder':
                    if (el) {
                        const width = baseVal * 2.5; 
                        el.setAttribute('x1', 100 - width);
                        el.setAttribute('x2', 100 + width);
                    }
                    break;
                case 'chest':
                case 'waist':
                case 'hip':
                    if (el) {
                        el.setAttribute('rx', baseVal);
                    }
                    break;
                case 'sleeve_len':
                    if (elL && elR) {
                        const len = baseVal * 3;
                        elL.setAttribute('x2', 65 - (len/4));
                        elL.setAttribute('y2', 100 + len);
                        elR.setAttribute('x2', 135 + (len/4));
                        elR.setAttribute('y2', 100 + len);
                    }
                    break;
                case 'length':
                case 'outseam':
                case 'inseam':
                    if (el) {
                        el.setAttribute('y2', 80 + (baseVal * 4));
                    }
                    break;
                case 'neck':
                    if (el) {
                        el.setAttribute('r', 5 + (baseVal/4));
                    }
                    break;
            }
            
            document.getElementById('v-feedback').innerText = `SAVED: ${key.toUpperCase()}`;
        }

        function syncVisualizerStates() {
            const config = GARMENT_CONFIG[state.currentGarment];
            config.forEach(item => {
                const els = [
                    document.getElementById(`v-${item.key}`),
                    document.getElementById(`v-${item.key}-L`),
                    document.getElementById(`v-${item.key}-R`)
                ];

                els.forEach(el => {
                    if (!el) return;
                    el.classList.remove('v-active', 'v-completed');
                    
                    const isCurrent = config[state.currentStepIndex].key === item.key;
                    const isDone = !!state.values[item.key];
                    
                    if (isCurrent) el.classList.add('v-active');
                    else if (isDone) el.classList.add('v-completed');
                });
            });
        }

        function resetVisualizer() {
            const svg = document.getElementById('body-visualizer-svg');
            // Reset visibility for pant specifics
            const outseam = document.getElementById('v-outseam');
            const inseam = document.getElementById('v-inseam');
            const shoulder = document.getElementById('v-shoulder');
            const shirtLen = document.getElementById('v-length');

            if (state.currentGarment === 'pant') {
                if (outseam) outseam.style.display = 'block';
                if (inseam) inseam.style.display = 'block';
                if (shoulder) shoulder.style.display = 'none';
                if (shirtLen) shirtLen.style.display = 'none';
            } else {
                if (outseam) outseam.style.display = 'none';
                if (inseam) inseam.style.display = 'none';
                if (shoulder) shoulder.style.display = 'block';
                if (shirtLen) shirtLen.style.display = 'block';
            }

            document.getElementById('v-feedback').innerText = "READY";
        }

        function toggleGlobalUnits() {
            const oldUnit = state.unit;
            state.unit = document.getElementById('unit-toggle').value;
            
            // Convert existing values
            Object.keys(state.values).forEach(key => {
                let v = state.values[key];
                if (state.unit === 'cm' && oldUnit === 'inch') v = v * 2.54;
                if (state.unit === 'inch' && oldUnit === 'cm') v = v / 2.54;
                state.values[key] = Math.round(v * 10) / 10;
            });

            renderFlow();
        }

        // 6. Voice Engine
        // 6. Voice Engine (HARDENED – AUDIO ONLY FIX)

function initSpeech() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (!SpeechRecognition) {
        console.warn("Speech Recognition not supported.");
        return;
    }

    state.recognition = new SpeechRecognition();
    state.recognition.continuous = true;
    state.recognition.interimResults = true;
    state.recognition.lang = 'en-US';

    state.recognition.onresult = (event) => {
        if (!state.currentGarment) return; // guard

        let interimTranscript = '';

        for (let i = event.resultIndex; i < event.results.length; ++i) {
            const transcript = event.results[i][0].transcript.toLowerCase();

            if (event.results[i].isFinal) {
                processVoiceCommand(transcript);
            } else {
                interimTranscript += transcript;
            }
        }

        document.getElementById('voice-transcript').innerText =
            interimTranscript || "Listening...";
    };

    state.recognition.onerror = (e) => {
        console.warn("Speech error:", e.error);
        if (state.isListening) {
            stopVoiceSafe();
        }
    };

    state.recognition.onend = () => {
        // Prevent stuck UI if recognition stops unexpectedly
        if (state.isListening) {
            try {
                state.recognition.start();
            } catch (err) {
                stopVoiceSafe();
            }
        }
    };
}

function toggleVoice() {
    if (!state.recognition || !state.currentGarment) return;

    if (state.isListening) {
        stopVoiceSafe();
    } else {
        startVoiceSafe();
    }
}

function startVoiceSafe() {
    try {
        state.recognition.start();
        state.isListening = true;
        document.getElementById('voice-toggle-btn').classList.add('listening');
        document.getElementById('voice-transcript').innerText = "Say measurements...";
    } catch (e) {
        console.warn("Voice start blocked:", e);
    }
}

function stopVoiceSafe() {
    try {
        state.recognition.stop();
    } catch (e) {}

    state.isListening = false;
    document.getElementById('voice-toggle-btn').classList.remove('listening');
    document.getElementById('voice-transcript').innerText = "Voice stopped.";
}

function processVoiceCommand(text) {
    if (!state.currentGarment) return;

    document.getElementById('voice-transcript').innerText = `Heard: "${text}"`;

    const config = GARMENT_CONFIG[state.currentGarment];
    if (!config) return;

    // --- Name Capture ---
    if (text.includes('name ')) {
        const nameValue = text.split('name ')[1]?.trim();
        if (nameValue) {
            document.getElementById('cust-name').value = nameValue;
            playSuccessCue();
        }
        return;
    }

    // --- Phone Capture ---
    const phoneMatch = text.match(/(phone|mobile|number|cell)\s*(.*)/);
    if (phoneMatch && phoneMatch[2]) {
        const phoneValue = phoneMatch[2].replace(/\D/g, '');
        if (phoneValue) {
            document.getElementById('cust-phone').value = phoneValue;
            playSuccessCue();
        }
        return;
    }

    const extractNumbers = (t) => {
        return t.replace(/point/g, '.')
            .split(' ')
            .map(w => parseFloat(w))
            .filter(n => !isNaN(n));
    };

    if (state.voiceMode === 'SEQUENCE') {
        const nums = extractNumbers(text);
        nums.forEach(n => {
            if (state.currentStepIndex >= config.length) return;

            const key = config[state.currentStepIndex].key;

            state.history.push({ key, prevValue: state.values[key] });
            updateValue(key, n);
        });

        if (nums.length > 0) playSuccessCue();
    } else {
        let captured = false;

        config.forEach(item => {
            item.synonyms.forEach(syn => {
                if (text.includes(syn)) {
                    const sub = text.split(syn)[1];
                    const nums = extractNumbers(sub);

                    if (nums.length > 0) {
                        state.history.push({
                            key: item.key,
                            prevValue: state.values[item.key]
                        });

                        updateValue(item.key, nums[0]);
                        captured = true;
                    }
                }
            });
        });

        if (captured) playSuccessCue();
    }
}

function undoLastVoice() {
    if (!state.currentGarment || state.history.length === 0) return;

    const last = state.history.pop();

    if (last.prevValue === undefined) {
        delete state.values[last.key];
        updateVisualizer(last.key, 0);
    } else {
        state.values[last.key] = last.prevValue;
        updateVisualizer(last.key, last.prevValue);
    }

    const idx = GARMENT_CONFIG[state.currentGarment]
        .findIndex(c => c.key === last.key);

    if (idx >= 0) state.currentStepIndex = idx;

    renderFlow();
}

        function isMobile() {
            return window.matchMedia("(max-width: 768px)").matches;
        }

        function refreshMobileNav() {
            const nav = document.getElementById("mobile-nav");
            if (!nav) return;

            const measurementPhase = document.getElementById("measurement-phase");
            const isActive = !!state.currentGarment && measurementPhase && measurementPhase.style.display !== "none";

            nav.style.display = (isMobile() && isActive) ? "flex" : "none";

            if (!state.currentGarment) return;

            const config = GARMENT_CONFIG[state.currentGarment] || [];
            if (config.length === 0) return;

            const current = config[state.currentStepIndex] || config[0];

            const progress = Math.round((Object.keys(state.values).length / config.length) * 100);

            const titleEl = document.getElementById("m-step-title");
            const countEl = document.getElementById("m-step-count");
            const pctEl = document.getElementById("m-step-pct");
            const fillEl = document.getElementById("m-progress-fill");
            const prevBtn = document.getElementById("m-prev");
            const nextBtn = document.getElementById("m-next");

            if (titleEl) titleEl.innerText = current.label || "Step";
            if (countEl) countEl.innerText = `${state.currentStepIndex + 1}/${config.length}`;
            if (pctEl) pctEl.innerText = `${progress}% Complete`;
            if (fillEl) fillEl.style.width = `${progress}%`;

            if (prevBtn) prevBtn.disabled = state.currentStepIndex === 0;
            if (nextBtn) nextBtn.disabled = state.currentStepIndex >= config.length - 1;

            lucide.createIcons();
        }

        function scrollToActiveField() {
            if (!state.currentGarment) return;
            const config = GARMENT_CONFIG[state.currentGarment] || [];
            const key = config[state.currentStepIndex]?.key;
            if (!key) return;

            const field = document.getElementById(`field-${key}`);
            if (!field) return;

            field.scrollIntoView({ behavior: "smooth", block: "start" });
            const input = field.querySelector(".big-input");
            if (input) setTimeout(() => input.focus(), 250);
        }

        function mobilePrev() {
            if (!state.currentGarment) return;
            if (state.currentStepIndex > 0) {
                goToStep(state.currentStepIndex - 1);
                scrollToActiveField();
            }
        }

        function mobileNext() {
            if (!state.currentGarment) return;
            const config = GARMENT_CONFIG[state.currentGarment] || [];
            if (state.currentStepIndex < config.length - 1) {
                goToStep(state.currentStepIndex + 1);
                scrollToActiveField();
            }
        }


        // 7. Output & Storage
        function saveCurrentOrder() {
            const name = document.getElementById('cust-name').value;
            const phone = document.getElementById('cust-phone').value;
            const orderId = document.getElementById('order-id').value;

            if (!name || !phone) {
                showModal("Missing Info", "Please enter customer name and phone number before saving.");
                return;
            }

            const config = GARMENT_CONFIG[state.currentGarment];
            const missing = config.filter(c => c.req && !state.values[c.key]);
            
            if (missing.length > 0) {
                showModal("Incomplete Data", `Required fields missing: ${missing.map(m => m.label).join(', ')}`);
                return;
            }

            const order = {
                id: orderId,
                name,
                phone,
                type: state.currentGarment,
                date: new Date().toLocaleDateString(),
                unit: state.unit,
                measurements: { ...state.values }
            };

            const saved = JSON.parse(localStorage.getItem('tf_orders') || '[]');
            saved.unshift(order);
            localStorage.setItem('tf_orders', JSON.stringify(saved));
            
            showModal("Order Saved", "Successfully saved order to local storage.");
            resetOrder();
            renderOrders();
            switchTab('orders-list');
        }

        function renderOrders() {
            const container = document.getElementById('orders-container');
            const search = document.getElementById('order-search').value.toLowerCase();
            const raw = localStorage.getItem('tf_orders') || '[]';
            let orders = JSON.parse(raw);

            if (search) {
                orders = orders.filter(o => o.name.toLowerCase().includes(search) || o.phone.includes(search) || o.id.toLowerCase().includes(search));
            }

            if (orders.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #94a3b8;">No orders found.</div>';
                return;
            }

            container.innerHTML = `
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>ID</th>
                            <th>Customer</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${orders.map((o, idx) => `
                            <tr>
                                <td>${o.date}</td>
                                <td><strong>${o.id}</strong></td>
                                <td>${o.name}<br><small style="color:#64748b">${o.phone}</small></td>
                                <td><span style="text-transform: capitalize;">${o.type}</span></td>
                                <td><span style="color:var(--success)">Saved</span></td>
                                <td>
                                    <button class="btn btn-ghost" style="padding: 5px 10px;" onclick="viewOrder('${o.id}')">View</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function viewOrder(id) {
            const orders = JSON.parse(localStorage.getItem('tf_orders') || '[]');
            const order = orders.find(o => o.id === id);
            if (!order) return;

            state.currentGarment = order.type;
            state.values = order.measurements;
            state.unit = order.unit;
            state.currentStepIndex = 0;
            state.showAll = true;
            
            document.getElementById('selection-phase').style.display = 'none';
            document.getElementById('measurement-phase').style.display = 'grid';
            document.getElementById('cust-name').value = order.name;
            document.getElementById('cust-phone').value = order.phone;
            document.getElementById('order-id').value = order.id;
            
            switchTab('new-order');
            renderFlow();
            
            // Re-apply all visualizer values
            Object.keys(order.measurements).forEach(k => updateVisualizer(k, order.measurements[k]));
        }

        function readBackAll() {
            if (!window.speechSynthesis) return;
            const config = GARMENT_CONFIG[state.currentGarment];
            const msg = new SpeechSynthesisUtterance();
            let text = `Reading back ${state.currentGarment} measurements for ${document.getElementById('cust-name').value || 'the customer'}. `;
            
            config.forEach(step => {
                if (state.values[step.key]) {
                    text += `${step.label}, ${state.values[step.key]} ${state.unit}s. `;
                }
            });

            msg.text = text;
            window.speechSynthesis.speak(msg);
        }

        /**
         * LUXURY PRINT FUNCTIONALITY
         */
        function printLuxuryReceipt() {
            const name = document.getElementById('cust-name').value || "N/A";
            const phone = document.getElementById('cust-phone').value || "N/A";
            const orderId = document.getElementById('order-id').value || "N/A";
            const date = new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric' });

            document.getElementById('print-order-id').innerText = orderId;
            document.getElementById('print-date').innerText = date;
            document.getElementById('print-garment-type').innerText = state.currentGarment || "Custom";
            document.getElementById('print-unit').innerText = state.unit;
            document.getElementById('print-cust-name').innerText = name;
            document.getElementById('print-cust-phone').innerText = phone;

            const grid = document.getElementById('print-measurements-grid');
            grid.innerHTML = '';
            
            const config = GARMENT_CONFIG[state.currentGarment];
            config.forEach(step => {
                const val = state.values[step.key];
                if (val) {
                    const item = document.createElement('div');
                    item.className = 'receipt-item';
                    item.innerHTML = `
                        <span class="label">${step.label.toUpperCase()}</span>
                        <span class="value">${val} ${state.unit}</span>
                    `;
                    grid.appendChild(item);
                }
            });

            window.print();
        }

        // 8. Modal Helper
        function showModal(title, message, confirmAction = null) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            const overlay = document.getElementById('confirm-modal');
            const confirmBtn = document.getElementById('modal-confirm-btn');
            
            overlay.style.display = 'flex';
            
            if (confirmAction) {
                confirmBtn.style.display = 'block';
                confirmBtn.onclick = () => { confirmAction(); closeModal(); };
            } else {
                confirmBtn.style.display = 'none';
            }
        }

        function closeModal() {
            document.getElementById('confirm-modal').style.display = 'none';
        }

    </script>
</body>
</html>